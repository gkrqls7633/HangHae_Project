# ποΈ λ™μ‹μ„± μ΄μ λ³΄κ³ μ„

## λ™μ‹μ„± μ΄μ λ°μƒ μ§€μ  μ„ λ³„
- **μΆμ„ μ„ μ (μμ•½)**
- **μ μ € ν¬μΈνΈ μ”μ•΅**

---

# 1. λ¬Έμ  μ‹λ³„ - μΆμ„ μ„ μ (μμ•½)

### κ°μ”

λ³Έ μ• ν”λ¦¬μΌ€μ΄μ…μ€ λ‹¤μμ μ‚¬μ©μκ°€ μ½μ„νΈ μΆμ„μ„ μμ•½ν•  μ μλ” μ‹μ¤ν…μ΄λ‹¤. λ™μ‹μ— μ—¬λ¬ μ‚¬μ©μκ°€ λ™μΌν• μΆμ„μ„ μμ•½ν•λ ¤λ” μƒν™©μ΄ λ°μƒν•  μ μμΌλ©°, μ΄λ¬ν• κ²½μ° **λ™μ‹μ„± μ μ–΄κ°€ μ μ ν•μ§€ μ•μΌλ©΄ λ™μΌ μΆμ„μ΄ μ¤‘λ³µ μμ•½**λλ” λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤.

### λ°μƒν• μ΄μ
λ™μΌν• μ μ €κ°€ λ™μ‹μ— μ—¬λ¬ λ² μΆμ„ μ μ  μ”μ²­μ„ λ³΄λ‚΄λ” κ²½μ°, νΈλμ­μ… λ‚΄μ—μ„ μΆμ„ μƒνƒλ¥Ό μ΅°νν•κ³  μ μ ν•λ” κ³Όμ •μ—μ„ λ™μ‹μ„± λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤.
μ΄ κ²½μ°, μ—¬λ¬ μ¤λ λ“κ°€ ν•΄λ‹Ή μΆμ„ μƒνƒλ¥Ό λ™μ‹μ— μ΅°νν•κ³  μ—…λ°μ΄νΈν•λ ¤ ν•  λ•, Race Conditionμ΄ λ°μƒν•  κ°€λ¥μ„±μ΄ μλ‹¤.
μ•„λλ” 3κ°μ μ¤λ λ“κ°€ λ™μ‹μ— λ™μΌν• μΆμ„μ„ μμ•½ μ”μ²­ν• ν…μ¤νΈ μ½”λ“μ΄λ‹¤.

```java
  @DisplayName("λ™μΌ μΆμ„ λ™μ‹ μμ•½ μ”μ²­ μ‹ ν•λ‚λ§ μ„±κ³µν•΄μ•Ό ν•λ‹¤.")
  @Test
  void testConcurrencyBookingSeatTest() throws InterruptedException {
    int threadCount = 3;
    ExecutorService executorService = Executors.newFixedThreadPool(threadCount);
    CountDownLatch latch = new CountDownLatch(threadCount);

    //futureλ΅ λΉ„λ™κΈ° μ‘μ—… λ°›μ„ μ μκ² μ²λ¦¬
    List<Future<ResponseMessage<BookingResponse>>> results = new ArrayList<>();

    for (int i = 0; i < threadCount; i++) {
        Future<ResponseMessage<BookingResponse>> result = executorService.submit(() -> {
            try {
                return bookingService.bookingSeat(bookingRequest);
            } catch (Exception e) {
                return ResponseMessage.error(500, e.getMessage());
            } finally {
                latch.countDown();
            }
        });
        results.add(result);
    }


      latch.await(); // λ¨λ“  μ¤λ λ“ μ™„λ£κΉμ§€ λ€κΈ°

      long successCount = results.stream()
              .filter(future -> {
                  try {
                      return future.get().getStatus() == 200;
                  } catch (Exception e) {
                      return false;
                  }
              })
              .count();

      long failCount = results.stream()
              .filter(future -> {
                  try {
                      return future.get().getStatus() != 200;
                  } catch (Exception e) {
                      return true;
                  }
              })
              .count();

      System.out.println("μ„±κ³µν• μμ•½ μ”μ²­ μ: " + successCount);
      System.out.println("μ‹¤ν¨ν• μμ•½ μ”μ²­ μ: " + failCount);

      // κΈ°λ€: μ„±κ³µ 1κ±΄
      assertEquals(1, successCount);
  }
```

**ν…μ¤νΈ κ²°κ³Ό:**

- β… μ„±κ³µν• μμ•½ μ”μ²­ μ: 2
- β μ‹¤ν¨ν• μμ•½ μ”μ²­ μ: 1

---

### κΈ°λ€ κ²°κ³Ό vs μ‹¤μ  κ²°κ³Ό

| ν•­λ© | κΈ°λ€κ°’ | μ‹¤μ κ°’ |
|------|--------|--------|
| μ„±κ³µ μ”μ²­ μ | 1 | 2 |
| μ‹¤ν¨ μ”μ²­ μ | 2 | 1 |
| μΆμ„ μ¤‘λ³µ μμ•½ μ—¬λ¶€ | μ—†μ | μμ |


π“ μ™ 3κ° λ¨λ‘ μ„±κ³µν•μ§€ λ»ν–λ”μ§€?

| μ΄μ  | μ„¤λ… | 
|------|--------|
| Race Condition | 3κ°μ μ¤λ λ“κ°€ λ™μ‹μ— μ‹¤ν–‰λλ©° λ¨λ‘ μ΅°κ±΄μ„ ν†µκ³Όν•¨ |
| νƒ€μ΄λ° μ°¨μ΄ | κ·Έ μ¤‘ 2κ°κ°€ λ” λΉ¨λ¦¬ μ €μ¥μ„ λ§μ³¤κ³ , 1κ°λ” λ¦κ² μ‹λ„ν•¨ |
| λ™μ‹μ„± μ μ–΄ μ—†μ |λ½μ΄ μ—†μΌλ‹ νΈλμ­μ… κ°„ λ°μ΄ν„° μ¶©λμ„ κ°μ§€ λ»ν•¨|
| κ²°κ³Ό | 2κ°λ” μ„±κ³µ, 1κ°λ” μ‹¤ν¨ β†’ μλ„ν• λ™μ‘μ΄ μ•„λ‹! |


---
## λ¬Έμ  λ¶„μ„

### μ½”λ“ νλ¦„ μ”μ•½

1. **Seat μ΅°ν**: `concertId`μ™€ `seatNum`μ„ κΈ°μ¤€μΌλ΅ μΆμ„μ„ μ΅°νν•©λ‹λ‹¤.
2. **μμ•½ κ°€λ¥ μ—¬λ¶€ ν™•μΈ**: `booking.isAvailableBooking()`μ„ ν†µν•΄ μμ•½ κ°€λ¥ν• μΆμ„μΈμ§€ ν™•μΈν•©λ‹λ‹¤.
3. **μΆμ„ μƒνƒ λ³€κ²½**: μμ•½μ΄ κ°€λ¥ν•λ‹¤λ©΄, μΆμ„ μƒνƒλ¥Ό `OCCUPIED`λ΅ λ³€κ²½ν•©λ‹λ‹¤.
4. **μμ•½ μ²λ¦¬**: `bookingRepository.save()`λ¥Ό ν†µν•΄ μμ•½ μ •λ³΄λ¥Ό μ €μ¥ν•©λ‹λ‹¤.

```java
Seat seat = seatRepository.findByConcertSeat_Concert_ConcertIdAndSeatNum(bookingRequest.getConcertId(), bookingRequest.getSeatNum())
        .orElseThrow(() -> new EntityNotFoundException("ν•΄λ‹Ή μΆμ„μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤."));

// 2. Booking λ„λ©”μΈ κ°μ²΄ μƒμ„±
Booking booking = new Booking(concert, bookingRequest.getSeatNum(), user);

// 3. μμ•½ κ°€λ¥ μ—¬λ¶€ ν™•μΈ
//  bookingμ seatNumμ μΆμ„ μ μ  μ—¬λ¶€ μ²΄ν¬
if (!booking.isAvailableBooking()) {
return ResponseMessage.error(500, "μ„ νƒ μΆμ„μ€ μμ•½ λ¶κ°€λ¥ν• μΆμ„μ…λ‹λ‹¤.");

} else {
        //μΆμ„ μ μ  μ²λ¦¬
        seat.setSeatStatus(SeatStatus.OCCUPIED);
    seatRepository.save(seat);

// booking μμ•½ μ²λ¦¬
    bookingRepository.save(booking);
}

```
Seat μ΅°ν β†’ μμ•½ κ°€λ¥ μ—¬λ¶€ νλ‹¨ β†’ μƒνƒ λ³€κ²½ β†’ μ €μ¥ μμΌλ΅ λ™μ‘

μ΄ λ΅μ§μ€ νΈλμ­μ…μΌλ΅ λ¬¶μ—¬ μμΌλ‚, μ΅°νμ™€ μ €μ¥ μ‚¬μ΄μ νƒ€μ΄λ° κ°„κ²©μ—μ„ Race Conditionμ΄ λ°μƒν•  μ μλ‹¤.

---

### μ΄μ λ°μƒ μ›μΈ

- μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— λ™μΌν• Seat μ—”ν‹°ν‹°λ¥Ό μ΅°ν
- κ°κ° μƒνƒκ°€ AVAILABLEμΈ κ²ƒμ„ ν™•μΈν•κ³  μ΅°κ±΄μ„ ν†µκ³Ό
- κ±°μ λ™μ‹μ— μƒνƒλ¥Ό OCCUPIEDλ΅ λ³€κ²½ν•κ³  μ €μ¥
- κ·Έ κ²°κ³Ό, μ—¬λ¬ κ±΄μ μμ•½μ΄ μ„±κ³µν•΄λ²„λ¦¬λ” μ¤‘λ³µ μμ•½ λ°μƒ

νΉν ν•λ‚μ μ”μ²­μ€ λ‹¤λ¥Έ μ”μ²­λ³΄λ‹¤ λ¦κ² μ»¤λ°‹λλ©΄μ„, μ΄λ―Έ OCCUPIEDκ°€ λ μΆμ„μ„ λ³΄κ³  μ‹¤ν¨ν• κ²ƒμΌλ΅ μ¶”μ •λλ‹¤.
μ΄ κ³Όμ •μ—μ„ Race Conditionμ΄ λ°μƒν•κ³ , μ΄λ” λ™μ‹μ„± λ¬Έμ κ°€ λ°μƒν•λ‹¤.


---

### λ™μ‹μ„± μ΄μ ν•΄κ²° λ°©μ•


---

# 2. λ¬Έμ  μ‹λ³„ - μ μ € ν¬μΈνΈ μ”μ•΅

### κ°μ”
λ³Έ μ• ν”λ¦¬μΌ€μ΄μ…μ€ μ μ €κ°€ ν¬μΈνΈλ¥Ό μ¶©μ „ν•  μ μλ” κΈ°λ¥μ„ μ κ³µν•λ‹¤. μ μ €κ°€ ν¬μΈνΈλ¥Ό μ¶©μ „ν•λ ¤κ³  ν•  λ•, νΈλμ­μ… λ‚΄μ—μ„ ν¬μΈνΈ μ”μ•΅μ„ μ΅°νν•κ³  μ—…λ°μ΄νΈν•λ” μ‘μ—…μ΄ μ΄λ£¨μ–΄μ§„λ‹¤. ν•μ§€λ§, λ™μΌν• μ μ €κ°€ λ™μ‹μ— μ—¬λ¬ λ² ν¬μΈνΈ μ¶©μ „ μ”μ²­μ„ λ³΄λ‚Ό κ²½μ°, λ™μ‹μ„± λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤. νΉν, μ¤‘λ³µλ μ”μ²­μ΄ μμ„ κ²½μ°, μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— κ°™μ€ μ μ €μ ν¬μΈνΈλ¥Ό μμ •ν•λ ¤ ν•  λ•, ν¬μΈνΈκ°€ μ¤‘λ³µμΌλ΅ μ¶©μ „λλ” λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤.

### λ°μƒν• μ΄μ
λ™μΌν• μ μ €κ°€ λ™μ‹μ— μ—¬λ¬ λ² ν¬μΈνΈ μ¶©μ „ μ”μ²­μ„ λ³΄λ‚΄λ” κ²½μ°, νΈλμ­μ… λ‚΄μ—μ„ ν¬μΈνΈλ¥Ό μ΅°νν•κ³  μ¶©μ „ν•λ” κ³Όμ •μ—μ„ λ™μ‹μ„± λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤. μ΄ κ²½μ°, μ—¬λ¬ μ¤λ λ“κ°€ κ°™μ€ μ μ €μ ν¬μΈνΈ μ”μ•΅μ„ λ™μ‹μ— μ΅°νν•κ³  μ—…λ°μ΄νΈν•λ ¤ ν•  λ•, Race Conditionμ΄ λ°μƒν•  κ°€λ¥μ„±μ΄ μλ‹¤. νΉν, ν•λ‚μ μ¤λ λ“κ°€ ν¬μΈνΈλ¥Ό μ΅°νν•κ³  μ—…λ°μ΄νΈν• ν›„, λ‹¤λ¥Έ μ¤λ λ“λ„ λ™μΌν• μ •λ³΄λ¥Ό μ΅°νν•μ—¬ μ¤‘λ³µλ ν¬μΈνΈ μ¶©μ „μ„ μ§„ν–‰ν•λ” μƒν™©μ΄ λ°μƒν•  μ μλ‹¤.

### μμ‹ μ‹λ‚λ¦¬μ¤:
1. μ μ € Aκ°€ 100,000ν¬μΈνΈλ¥Ό μ¶©μ „ν•λ ¤λ” μ”μ²­μ„ λ³΄λ‚Έλ‹¤.
2. λ™μ‹μ— λ„¤νΈμ›ν¬ λ¬Έμ λ‚ UI μ§€μ—°μΌλ΅ κ°™μ€ μ”μ²­μ΄ λ‘ λ² μ„λ²„μ— λ„λ‹¬ν•λ‹¤.
3. λ‘ μ”μ²­μ΄ κ±°μ λ™μ‹μ— μ²λ¦¬λλ©°, ν¬μΈνΈ μ”μ•΅μ„ μ¤‘λ³µμΌλ΅ μ¦κ°€μ‹ν‚¤κ² λλ‹¤.

```java
@DisplayName("λ™μΌ μ μ €μ— λ€ν•΄ λ™μ‹ ν¬μΈνΈ μ¶©μ „ μ”μ²­ μ‹ ν•λ‚λ§ μ„±κ³µν•΄μ•Ό ν•λ‹¤.")
@Test
void testConcurrencyChargePointTest() throws InterruptedException {
    int threadCount = 3;
    ExecutorService executorService = Executors.newFixedThreadPool(threadCount);
    CountDownLatch latch = new CountDownLatch(threadCount);

    PointChargeRequest pointChargeRequest = new PointChargeRequest(savedUserId, 100000L);
    
    List<Future<ResponseMessage<PointResponse>>> results = new ArrayList<>();
    
    for (int i = 0; i < threadCount; i++) {
        Future<ResponseMessage<PointResponse>> result = executorService.submit(() -> {
            try {
                return pointService.chargePoint(pointChargeRequest);
            } catch (Exception e) {
                return ResponseMessage.error(500, e.getMessage());
            } finally {
                latch.countDown();
            }
        });
        results.add(result);
    }
    
    latch.await();
    
    long successCount = results.stream()
            .filter(future -> {
                try {
                    return future.get().getStatus() == 200;
                } catch (Exception e) {
                    return false;
                }
            })
            .count();
    
    long failCount = results.stream()
            .filter(future -> {
                try {
                    return future.get().getStatus() != 200;
                } catch (Exception e) {
                    return true;
                }
            })
            .count();
    
    System.out.println("μ„±κ³µν• ν¬μΈνΈ μ¶©μ „ μ”μ²­ μ: " + successCount);
    System.out.println("μ‹¤ν¨ν• ν¬μΈνΈ μ¶©μ „ μ”μ²­ μ: " + failCount);
    
    // κΈ°λ€: μ¶©μ „ μ„±κ³µ 1κ±΄, μ‹¤ν¨ 2κ±΄
    assertEquals(1, successCount);  // μ¤‘λ³µ μ¶©μ „μ΄ λ°μƒν•μ§€ μ•λ„λ΅ 1λ²λ§ μ„±κ³µν•΄μ•Ό ν•¨
}
```
**ν…μ¤νΈ κ²°κ³Ό:**

- λ½ μ²λ¦¬ ν•μ§€ μ•μ€ κ²½μ° κ²°κ³Ό
  ![img.png](ν¬μΈνΈμ¶©μ „_λ½x.png)

---

### κΈ°λ€ κ²°κ³Ό vs μ‹¤μ  κ²°κ³Ό

| ν•­λ©        | κΈ°λ€κ°’ | μ‹¤μ κ°’ |
|-----------|-----|-----|
| μ„±κ³µ μ”μ²­ μ   | 1   | 10  |
| μ‹¤ν¨ μ”μ²­ μ   | 0   | 0   |
| μ¤‘λ³µ ν¬μΈνΈ μ¶©μ „ | μ—†μ  | μμ  |

---

## λ¬Έμ  λ¶„μ„

### μ½”λ“ νλ¦„ μ”μ•½
ν„μ¬μ ν¬μΈνΈ μ¶©μ „ λ΅μ§μ—μ„λ” λ‹¤μκ³Ό κ°™μ€ μμ„λ΅ μ‘μ—…μ΄ μ²λ¦¬λλ‹¤:
1. ν¬μΈνΈ μ΅°ν: pointRepository.findById(userId)λ¥Ό ν†µν•΄ μ μ €μ ν„μ¬ ν¬μΈνΈ μ”μ•΅μ„ μ΅°ν.
2. ν¬μΈνΈ μ¶©μ „: chargePoint() λ©”μ„λ“κ°€ νΈμ¶λμ–΄ ν¬μΈνΈ μ”μ•΅μ„ μ¦κ°€μ‹ν‚΄.
3. ν¬μΈνΈ μ €μ¥: λ³€κ²½λ ν¬μΈνΈ μ”μ•΅μ„ pointRepository.save(point)λ¥Ό ν†µν•΄ μ €μ¥.

μ΄ λ΅μ§μ—μ„λ” μ΅°ν ν›„ μ—…λ°μ΄νΈκ°€ μ΄λ£¨μ–΄μ§€λ©°, νΈλμ­μ…μΌλ΅ λ¬¶μ—¬ μμ§€λ§, ν¬μΈνΈ μ΅°νμ™€ μ—…λ°μ΄νΈ μ‚¬μ΄μ— λ‹¤λ¥Έ μ¤λ λ“κ°€ κ°μ…ν•  μ μλ‹¤. 
μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— λ™μΌν• μ μ €μ— λ€ν•΄ ν¬μΈνΈλ¥Ό μ΅°νν•κ³  μ—…λ°μ΄νΈν•λ©΄, μ¤‘λ³µλ μ¶©μ „μ΄ λ°μƒν•  μ μλ‹¤.

```java
@Override
@Transactional
public ResponseMessage<PointResponse> chargePoint(PointChargeRequest pointChargeRequest) {

    Point point = pointRepository.findById(pointChargeRequest.getUserId())
            .orElseThrow(() -> new EntityNotFoundException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));
    
    //μ¶©μ „ νΈμ¶
    point.chargePoint(pointChargeRequest);
    
    //μ¶©μ „ μ €μ¥
    pointRepository.save(point);
    
    PointResponse pointResponse = PointResponse.builder()
            .pointBalance(point.getPointBalance())
            .build();
    
    return ResponseMessage.success("ν¬μΈνΈκ°€ μ •μƒμ μΌλ΅ μ¶©μ „λμµλ‹λ‹¤.", pointResponse);
}
```

### μ΄μ λ°μƒ μ›μΈ
1. λ™μ‹μ„± λ¬Έμ : μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— **pointRepository.findById()**λ΅ ν¬μΈνΈλ¥Ό μ΅°νν•κ³ , chargePoint() λ©”μ„λ“λ¥Ό νΈμ¶ν•μ—¬ ν¬μΈνΈλ¥Ό μμ •ν•λ ¤ μ‹λ„.
2. Race Condition: λ‘ μ¤λ λ“κ°€ κ±°μ λ™μ‹μ— ν¬μΈνΈ μ”μ•΅μ„ μ¦κ°€μ‹μΌ, ν¬μΈνΈκ°€ μ¤‘λ³µμΌλ΅ μ¶©μ „λλ” ν„μƒμ΄ λ°μƒ.
3. νΈλμ­μ… κ΄€λ¦¬ λ¶€μ΅±: λΉ„λ΅ νΈλμ­μ… λ‚΄μ—μ„ μ‘μ—…μ„ μ²λ¦¬ν•μ§€λ§, λ™μΌ μ μ €μ— λ€ν• ν¬μΈνΈ μ¶©μ „ μ‘μ—…μ΄ μ¤‘λ³µλλ„λ΅ λ§‰λ” μ μ–΄κ°€ λ¶€μ΅±ν•λ‹¤.

---

## λ™μ‹μ„± μ΄μ ν•΄κ²° λ°©μ•

### AS-IS

| κµ¬λ¶„        | λ‚΄μ©                            | 
|-----------|-------------------------------|
| νΈλμ­μ… κ΄€λ¦¬	  | μμ (@Transactional)           |
| λ™μ‹μ„± μ μ–΄	   | μ—†μ                            | 
| λ°μƒ κ°€λ¥ λ¬Έμ 	   | μ¤‘λ³µ μ¶©μ „, μ”μ•΅ λ¶μΌμΉ, Race Condition 
|


### TO-BE (λ‚™κ΄€μ „ λ½ vs λΉ„κ΄€μ  λ½)

1. **λ‚™κ΄€μ  λ½ μ μ©**
  - Point μ—”ν‹°ν‹°μ— @Version ν•„λ“ μ¶”κ°€
  - JPAκ°€ μλ™μΌλ΅ μ¶©λ μ‹ OptimisticLockException λ°μƒ

```java
@Entity
public class Point {

    @Id
    private Long userId;

    @OneToOne(fetch = FetchType.LAZY)
    @MapsId
    @JoinColumn(name = "user_id", nullable = false, unique = true)
    private User user;


    @Schema(description = "ν¬μΈνΈ μ”μ•΅", example = "10000")
    @JsonProperty("pointBalance")
    private Long pointBalance;
    
    @Version
    private Long version; // λ²„μ „ κ΄€λ¦¬ μ„ν•΄ version μ¶”κ°€
}
```
#### μ μ© κ²°κ³Ό
![img_1.png](ν¬μΈνΈμ¶©μ „_λ‚™κ΄€μ λ½.png)

```java
//λ‚™κ΄€μ  λ½ λ°μ λ©”μ„λ“
@Override
public ResponseMessage<PointResponse> chargePointWithLock(PointChargeRequest pointChargeRequest) {
  try {
    return chargePoint(pointChargeRequest);

  } catch (ObjectOptimisticLockingFailureException e) {
    log.error("μ¶©μ „ μ‹¤ν¨: Optimistic Lock μμ™Έ λ°μƒ", e);
    throw e;
  }
}

/**
 * @description μ μ €μ ν¬μΈνΈλ¥Ό μ¶©μ „ν•λ‹¤.
 * @param pointChargeRequest
 * @return
 */
@Override
@Transactional(propagation = Propagation.REQUIRES_NEW)
public ResponseMessage<PointResponse> chargePoint(PointChargeRequest pointChargeRequest) {

  //ν„μ¬ μ”μ•΅ μ΅°ν
  Point point = pointRepository.findById(pointChargeRequest.getUserId())
          .orElseThrow(() -> new EntityNotFoundException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));

  if (point.isCharged()) {
    throw new IllegalStateException("μ΄λ―Έ μ¶©μ „λ μ”μ²­μ…λ‹λ‹¤.");
  }

  //μ¶©μ „ νΈμ¶
  point.chargePoint(pointChargeRequest);

  //μ¶©μ „ μ €μ¥
  pointRepository.save(point);

  point.setCharged(true);

  PointResponse pointResponse = PointResponse.builder()
          .pointBalance(point.getPointBalance())
          .build();

  return ResponseMessage.success("ν¬μΈνΈκ°€ μ •μƒμ μΌλ΅ μ¶©μ „λμµλ‹λ‹¤.", pointResponse);
}
}
```

#### μ¥λ‹¨μ 

- μ¥μ 
  - λ½μ„ μ§μ ‘ κ±Έμ§€ μ•μ•„ μ„±λ¥ μ €ν•κ°€ μ λ‹¤.
  - λ€λ¶€λ¶„μ κ²½μ° μ¶©λ μ—†μ΄ λΉ λ¥΄κ² μ²λ¦¬λ¨.
- λ‹¨μ 
  - μ¶©λ λ°μƒ μ‹ μμ™Έ λ°μƒ -> μ¬μ‹λ„ λ΅μ§ ν•„μ”
  - λ°λ³µ μ”μ²­μ΄ λ§μ„ κ²½μ° μ²λ¦¬ μ‹¤ν¨μ¨ μ¦κ°€ κ°€λ¥


2. **λΉ„κ΄€μ  λ½ μ μ©**
- μ΅°ν μ‹ Pessimistic Lock κ±ΈκΈ°
- λΉ„κ΄€μ  λ½μ κ²½μ° λ™μ‹ μ”μ²­μ€ μ²λ¦¬μ¤‘μΈ μ¤λ λ“λ¥Ό μ μ™Έν•κ³  λ½μ„ κ±Έκ³ , λ€κΈ°ν• ν›„μ— μμ°¨μ μΌλ΅ μ²λ¦¬λλ―€λ΅ λ¨λ“  μ”μ²­μ΄ μ„±κ³µν•λ‹¤. ν¬μΈνΈ μ¶©μ „μ κ²½μ° λ¨λ“  μ”μ²­μ΄ μ„±κ³µν•λ©΄ μ•λκ³  μ¤‘λ³µ λ°©μ§€λ¥Ό μ„ν• λ½ μ²λ¦¬λ¥Ό ν•΄μ•Όν•λ―€λ΅ λΉ„κ΄€μ  λ½μ„ μ‚¬μ©ν•  κ²½μ°μ—” 'μ΄λ―Έ μ¶©μ „λ μ”μ²­'μ„μ„ μ• μ μλ„λ΅ μμ™Έμ²λ¦¬λ¥Ό μ¶”κ°€ν•λ‹¤.

```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT p FROM Point p WHERE p.userId = :userId")
Optional<Point> findByUserIdWithLock(@Param("userId") Long userId);

@Transactional
public ResponseMessage<PointResponse> chargePointWithPessimisticLock(PointChargeRequest pointChargeRequest) {

  // λΉ„κ΄€μ  λ½μ„ μ‚¬μ©ν•μ—¬ ν„μ¬ ν¬μΈνΈ μ •λ³΄ κ°€μ Έμ¤κΈ°
  Point point = pointRepository.findByUserIdForUpdate(pointChargeRequest.getUserId())
          .orElseThrow(() -> new EntityNotFoundException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));

  // μ΄λ―Έ μ¶©μ „λ μ”μ²­μΌ κ²½μ° μμ™Έμ²λ¦¬
  if (point.isCharged()) { // μ¶©μ „ μƒνƒλ¥Ό μ²΄ν¬ν•λ” λ΅μ§
    throw new IllegalStateException("μ΄λ―Έ μ¶©μ „λ μ”μ²­μ…λ‹λ‹¤.");
  }

  // μ¶©μ „ νΈμ¶
  point.chargePoint(pointChargeRequest);

  // μ¶©μ „ μƒνƒλ¥Ό μ—…λ°μ΄νΈ (μ¤‘λ³µ μ¶©μ „μ„ λ°©μ§€ν•κΈ° μ„ν•΄ ν”λκ·Έ μ—…λ°μ΄νΈ)
  point.setCharged(true);

  // ν¬μΈνΈ μ •λ³΄ μ €μ¥
  pointRepository.save(point);

  // μ¶©μ „ ν›„ μ‘λ‹µ λ°ν™
  PointResponse pointResponse = PointResponse.builder()
          .pointBalance(point.getPointBalance())
          .build();

  return ResponseMessage.success("ν¬μΈνΈκ°€ μ •μƒμ μΌλ΅ μ¶©μ „λμµλ‹λ‹¤.", pointResponse);
}
```

#### μ μ© κ²°κ³Ό

![img_2.png](ν¬μΈνΈμ¶©μ „_λΉ„κ΄€μ λ½.png)
  
#### μ¥λ‹¨μ 

- μ¥μ 
    - ν• λ²μ— ν•λ‚μ νΈλμ­μ…λ§ λ°μ΄ν„° μμ • κ°€λ¥ β†’ μ¶©λ μ—†μ
    - μ¶©λ μ¬μ‹λ„ λ΅μ§ λ¶ν•„μ” β†’ μ²λ¦¬ κ°„κ²°
- λ‹¨μ 
    - νΈλμ­μ… λ€κΈ° μ‹κ°„ λ°μƒ β†’ μ‘λ‹µ μ§€μ—°
    - Deadlock κ°€λ¥μ„± β†’ λ½ λ²”μ„ λ° μμ„ μ΅°μ‹¬ν•΄μ•Ό ν•¨
    - λ¨λ“  μ”μ²­μ΄ μ„±κ³µν•λ―€λ΅ μ΄λ¥Ό λ°©μ§€ν•κΈ° μ„ν• μ¶”κ°€ λ΅μ§ ν•„μ”
---

### 3. AS-IS / TO-BE λΉ„κµ

| ν•­λ©                | AS-IS (κΈ°μ΅΄)                       | TO-BE (Optimistic)                                 | TO-BE (Pessimistic)                              |
|---------------------|------------------------------------|----------------------------------------------------|--------------------------------------------------|
| λ™μ‹μ„± μ μ–΄         | β μ—†μ                            | β… λ²„μ „ κΈ°λ° μ μ–΄                                   | β… DB λ½ κΈ°λ° μ μ–΄                                 |
| μ²λ¦¬ λ°©μ‹           | λ³‘λ ¬ β†’ μ¶©λ κ°€λ¥                   | λ³‘λ ¬ β†’ μ¶©λ μ‹ μμ™Έ λ°μƒ β†’ μ¬μ‹λ„ ν•„μ”              | μ§λ ¬ β†’ λ€κΈ° λ°μƒ κ°€λ¥                             |
| μ¶©λ μ²λ¦¬           | β λ―Έμ²λ¦¬                          | π”„ μ¬μ‹λ„ λ΅μ§ ν•„μ”                                 | π« μ¶©λ μ—†μ                                      |
| μ„±λ¥                | π”Ό λΉ λ¦„ (μ¶©λ μ‹ μ„ν—)              | π”Ό μ¶©λ μ—†μΌλ©΄ λΉ λ¦„                                 | π”½ λλ¦΄ μ μμΌλ‚ μ•μ •μ                           |
| κµ¬ν„ λ‚μ΄λ„         | β… λ‹¨μ                            | π”„ μ¬μ‹λ„ λ΅μ§ ν•„μ”                                 | π”§ λ½ λ²”μ„/μμ„ μ„¤κ³„ ν•„μ”                         |
| λ°μ΄ν„° μ •ν•©μ„±       | β λ¶μ•μ •                          | β οΈ μ¶©λ μ‹ μ‹¤ν¨ κ°€λ¥                                | β… κ°•λ ¥ν• μ •ν•©μ„± λ³΄μ¥                             |

---
### μ–΄λ–¤ μ „λµμ΄ λ” νƒ€λ‹Ήν•κ°€?

#### π” ν¬μΈνΈ μ¶©μ „ κΈ°λ¥μ νΉμ„±

| μ”μ†                  | λ‚΄μ©                                           |
|-----------------------|------------------------------------------------|
| μ¤‘μ”λ„                | π’¥ μ μ € μμ‚°μ— κ΄€λ ¨λ μ¤‘μ”ν• κΈ°λ¥              |
| μ¶©λ κ°€λ¥μ„±           | μ¤‘λ³µ μ”μ²­ λ“±μΌλ΅ μΈν•΄ μ¶©λ λ°μƒ κ°€λ¥           |
| λ°μ΄ν„° μ •ν•©μ„± μ”κµ¬ μμ¤€ | λ§¤μ° λ†’μ                                      |
| μ‚¬μ©μ κΈ°λ€           | 1ν μ”μ²­ μ‹ μ •ν™•ν• ν¬μΈνΈ μ¶©μ „ λ³΄μ¥            |
| νΈλν”½/μ„±λ¥ μ”κµ¬       | μƒλ€μ μΌλ΅ λ‚®μ (λΉ„κ΄€μ  λ½ μ μ©μ—λ„ λ¶€λ‹΄ μ μ) |

β… κ²°λ΅ : λΉ„κ΄€μ  λ½μ΄ λ” νƒ€λ‹Ήν•λ‹¤κ³  λ³Ό μ μμΌλ‚, **λ‚™κ΄€μ  λ½**μΌλ΅ κ²°μ •ν•λ‹¤!

ν¬μΈνΈ μ¶©μ „μ κ²½μ°
- ν• μ μ €κ°€ λ™μ‹μ— μ—¬λ¬ μ”μ²­ λ³΄λ‚Ό κ°€λ¥μ„±μ€ λ‚®λ‹¤. κ·Έλ¬λ―€λ΅ κµ³μ΄ λΉ„κ΄€μ  λ½μ„ μ‚¬μ©ν•΄μ„ μ„±λ¥ μ €ν•μ‹ν‚¬ ν•„μ” μ—†λ‹¤κ³  νλ‹¨ν•λ‹¤.
- λΉ„κ΄€μ λ½μ€ λ™μ‹ μ”μ²­ μ‹, DB λ½μΌλ΅ μμ°¨μ μΌλ΅ μ²λ¦¬ -> λ¨λ“ μ„±κ³µ μ²λ¦¬μ‹ν‚¤λ” κ²ƒμ΄λ‹¤. ν¬μΈνΈ μ¶©μ „μ κ²½μ° ν• μ”μ²­λ§ μ²λ¦¬λμ–΄μ•Όν•  ν™•λ¥ μ΄ λ†’μΌλ―€λ΅ λ‚™κ΄€μ  λ½μΌλ΅ κ²°μ •ν•λ‹¤.
- λ¨λ“  μ”μ²­μ„ μ„±κ³µμ‹ν‚¤λ©΄ μ•λλ―€λ΅ λ‚™κ΄€μ  λ½μΌλ΅ κ²°μ •ν•λ‹¤.

---
## Lock μ „λµ κ°λ… λΉ„κµ(μ°Έκ³ )

π”’ DB Lock μ „λµ λΉ„κµ λ° μ μ© λ³΄κ³ μ„

| κµ¬λ¶„        | λ‚™κ΄€μ  λ½ (Optimistic Lock) | λΉ„κ΄€μ  λ½ (Pessimistic Lock) |
|-----------|--------|-----|
| κΈ°λ³Έ κ°λ…   | μ¶©λμ΄ λ°μƒν•μ§€ μ•μ„ κ±°λΌ λ‚™κ΄€ν•κ³  μ²λ¦¬. μ¶©λ λ°μƒ μ‹ μμ™Έ λ°μƒ λ° μ¬μ‹λ„ ν•„μ”. | μ¶©λμ΄ λ°μƒν•  μ μλ‹¤κ³  **κ°€μ •(λΉ„κ΄€)**ν•κ³ , λ°μ΄ν„°λ¥Ό μ½λ” μ‹μ μ— λ½μ„ κ±Έμ–΄ μ„ μ ν•¨.  |
| μ μ© λ°©μ‹   | @Version ν•„λ“λ΅ μ—”ν‹°ν‹° λ²„μ „μ„ κ΄€λ¦¬. νΈλμ­μ… μ»¤λ°‹ μ‹ λ²„μ „ λΉ„κµ. | JPAμ @Lock(LockModeType.PESSIMISTIC_WRITE) λ“±μΌλ΅ SQL λ λ²¨μ ν–‰ μ κΈ(Lock) μν–‰. |
| λ™μ‹μ„± μ²λ¦¬ λ°©μ‹   | νΈλμ­μ… κ°„ μ¶©λ μ‹ OptimisticLockException λ°μƒ β†’ μ¬μ‹λ„ ν•„μ” | ν•λ‚μ νΈλμ­μ…μ΄ λλ‚  λ•κΉμ§€ λ‹¤λ¥Έ νΈλμ­μ…μ€ λ€κΈ° λλ” μ°¨λ‹¨ |
| μ„±λ¥   | μ¶©λμ΄ μ μ€ κ²½μ° μ„±λ¥ μ°μ (λ½ X) | νΈλμ­μ… κ°„ κ²½μμ΄ λ§μ„μλ΅ μ„±λ¥ μ €ν•  |
| κµ¬ν„ λ‚μ΄λ„   | λΉ„κµμ  κ°„λ‹¨ν•μ§€λ§, μ¶©λ μ¬μ²λ¦¬ λ΅μ§ ν•„μ” | μΏΌλ¦¬μ™€ νΈλμ­μ… λ²”μ„λ¥Ό μ •ν™•ν μ΅°μ ν•΄μ•Ό ν•λ―€λ΅ μƒλ€μ μΌλ΅ κµ¬ν„ λ³µμ΅  |
| μ£Όλ΅ μ‚¬μ©ν•λ” κ³³   | μ½κΈ° λ§μ€ ν™κ²½, μ¶©λ μ κ³  λΉ λ¥Έ μ‘λ‹µμ΄ μ¤‘μ”ν• κ²½μ° (ex. μ΅°ν κΈ°λ° UI)| μ •ν•©μ„± μ¤‘μ”, μ¶©λ κ°€λ¥μ„±μ΄ λ†’μ€ ν™κ²½ (ex. μ€ν–‰, μ¬κ³ , μμ•½ μ‹μ¤ν… λ“±)  |


		
		
		
		
		
		