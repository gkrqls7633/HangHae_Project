# ì¹´í”„ì¹´ ê¸°ì´ˆ í•™ìŠµ ë° í™œìš© ë³´ê³ ì„œ

## ëª©ì°¨
[1. ì¹´í”„ì¹´ ê°œë…](#1-ì¹´í”„ì¹´-ê°œë…)

[2. ì¹´í”„ì¹´ í™˜ê²½ ì…‹íŒ… & ê¸°ë³¸ ê¸°ëŠ¥ ìˆ˜í–‰](#2-ì¹´í”„ì¹´-í™˜ê²½-ì…‹íŒ…-&-ê¸°ë³¸-ê¸°ëŠ¥-ìˆ˜í–‰)

[3. ê²°ë¡ ](#3-ê²°ë¡ )


# âœï¸ 1. ì¹´í”„ì¹´ ê°œë…

Apache KafkaëŠ” ëŒ€ìš©ëŸ‰ì˜ ì‹¤ì‹œê°„ ë¡œê·¸ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ë¶„ì‚° ìŠ¤íŠ¸ë¦¬ë° í”Œë«í¼ì…ë‹ˆë‹¤.  
ë³¸ ë³´ê³ ì„œì—ì„œëŠ” Kafkaì˜ ê¸°ë³¸ ê°œë…, ì£¼ìš” êµ¬ì„± ìš”ì†Œ, ë©”ì‹œì§€ ì „ì†¡ êµ¬ì¡°, í™œìš© ë°©ì‹ ë“±ì„ í•™ìŠµí•˜ê³ , ì´ë¥¼ ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ìš©í•œ ë‚´ìš©ì„ ì •ë¦¬í•©ë‹ˆë‹¤.

## ğŸ“Œ 1.1 ì¹´í”„ì¹´?
KafkaëŠ” ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì§•ì„ ê°€ì§„ ë©”ì‹œì§€ ë¸Œë¡œì»¤ì…ë‹ˆë‹¤:

- ê³ ì„±ëŠ¥ ë¶„ì‚° ë©”ì‹œì§• ì‹œìŠ¤í…œ
- ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„° ì²˜ë¦¬ ê°€ëŠ¥
- ë°ì´í„° ì˜ì†ì„±ê³¼ í™•ì¥ì„± ì§€ì›
- pub/sub êµ¬ì¡° ê¸°ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬


## ğŸ“Œ ì¹´í”„ì¹´ ì£¼ìš” êµ¬ì„± ìš”ì†Œ

| êµ¬ì„± ìš”ì†Œ     | ì„¤ëª… |
|--------------|------|
| **Producer** | Kafkaë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ |
| **Consumer** | Kafkaë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ì†Œë¹„í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ |
| **Broker**   | ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ê³  ì „ë‹¬í•˜ëŠ” Kafka ì„œë²„ |
| **Topic**    | ë©”ì‹œì§€ê°€ ì „ë‹¬ë˜ëŠ” ë…¼ë¦¬ì ì¸ ì±„ë„ |
| **Partition**| Topicì„ ë¶„í• í•˜ì—¬ ë³‘ë ¬ì„±ê³¼ í™•ì¥ì„±ì„ ì œê³µ |
| **Consumer Group** | ì—¬ëŸ¬ Consumerê°€ ë³‘ë ¬ë¡œ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ê·¸ë£¹í™” |

## ğŸ“Œ ë©”ì‹œì§€ ì „ì†¡ êµ¬ì¡° ë° íŒŒí‹°ì…˜
Producer â†’ [Kafka Topic Partition] â†’ Consumer Group

![ì¹´í”„ì¹´_êµ¬ì¡°.png](ì¹´í”„ì¹´_êµ¬ì¡°.png)

- ProducerëŠ” íŠ¹ì • Topicìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ„
- KafkaëŠ” ë©”ì‹œì§€ë¥¼ Topicì˜ Partitionì— ë¶„ë°°
- ConsumerëŠ” í•´ë‹¹ Partitionìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ì½ìŒ

![ì¹´í”„ì¹´_íŒŒí‹°ì…˜.png](ì¹´í”„ì¹´_íŒŒí‹°ì…˜.png)
- Apache Kafkaì—ì„œ íŒŒí‹°ì…˜(partition)ì€ ë°ì´í„° ì²˜ë¦¬ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ í•˜ê¸° ìœ„í•œ í•µì‹¬ ìš”ì†Œ
- íŒŒí‹°ì…˜ì€ íë¥¼ ë‚˜ëˆ ì„œ ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” ê¸°ë³¸ ë‹¨ìœ„ì´ë©°, Kafkaì˜ ê° í† í”½(topic)ì€ í•˜ë‚˜ ì´ìƒì˜ íŒŒí‹°ì…˜ìœ¼ë¡œ ë‚˜ëˆ ì ¸ ìˆìŒ
- ì´ë¥¼ í†µí•´ ë©”ì‹œì§€ê°€ ë³‘ë ¬ë¡œ ì²˜ë¦¬ë  ìˆ˜ ìˆìŒ
- ë‹¤ìŒê³¼ ê°™ì€ ì¥ì  ì¡´ì¬
  - ë³‘ë ¬ ì²˜ë¦¬: ì—¬ëŸ¬ ì»¨ìŠˆë¨¸(consumer)ê°€ ì„œë¡œ ë‹¤ë¥¸ íŒŒí‹°ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ë™ì‹œì— ì½ì„ ìˆ˜ ìˆê³ , ì´ëŠ” ì²˜ë¦¬ ì†ë„ë¥¼ í¬ê²Œ í–¥ìƒì‹œí‚´
  - ìˆœì„œ ë³´ì¥: í•˜ë‚˜ì˜ íŒŒí‹°ì…˜ ë‚´ì—ì„œëŠ” ë©”ì‹œì§€ì˜ ìˆœì„œê°€ ë³´ì¥ë˜ì–´, ìˆœì°¨ì ì¸ ë°ì´í„° ì²˜ë¦¬ê°€ í•„ìš”í•  ë•Œ ìœ ìš©í•¨
  - í™•ì¥ì„±: íŒŒí‹°ì…˜ì„ ì—¬ëŸ¬ ë…¸ë“œì— ë¶„ì‚°ì‹œì¼œ ì €ì¥í•  ìˆ˜ ìˆì–´ì„œ, ì‹œìŠ¤í…œì˜ í™•ì¥ì„±ì„ ë†’ì¼ ìˆ˜ ìˆìŒ

---

# âœï¸ 2. ì¹´í”„ì¹´ í™˜ê²½ ì…‹íŒ… & ê¸°ë³¸ ê¸°ëŠ¥ ìˆ˜í–‰

## ğŸ“Œ2-1. ì¹´í”„ì¹´ í™˜ê²½ ì…‹íŒ…

### Producer Config
```java
@Configuration
@EnableKafka
public class KafkaProducerConfig {

  @Bean
  public ProducerFactory<String, Object> factory() {
    Map<String, Object> props = new HashMap<>();
    props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
    props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
    props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class);

    return new DefaultKafkaProducerFactory<>(props);
  }

  @Bean
  public KafkaTemplate<String, Object> kafkaTemplate(){
    return new KafkaTemplate<>(factory());
  }
}

```

| ì„¤ì • í‚¤                        | ì„¤ëª…                                |
|-------------------------------|-------------------------------------|
| BOOTSTRAP_SERVERS_CONFIG      | Kafka ë¸Œë¡œì»¤ ì£¼ì†Œ (`localhost:9092`) |
| KEY_SERIALIZER_CLASS_CONFIG   | Keyë¥¼ ë¬¸ìì—´ë¡œ ì§ë ¬í™”                |
| VALUE_SERIALIZER_CLASS_CONFIG | Valueë¥¼ JSONìœ¼ë¡œ ì§ë ¬í™”             |

---

### Consumer Config
```java
@Configuration
@EnableKafka
public class KafkaConsumerConfig {

    //Kafka Consumerë¥¼ ìƒì„±í•˜ëŠ” ë° í•„ìš”í•œ ì„¤ì • ì •ë³´ë¥¼ ë‹´ì€ íŒ©í† ë¦¬
    public <T> ConsumerFactory<String, T> consumerFactory(Class<T> clazz, String groupId) {
        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        props.put(ConsumerConfig.GROUP_ID_CONFIG, groupId);
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class); //key ì—­ì§ë ¬í™”
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, JsonDeserializer.class); //value ì—­ì§ë ¬í™”

        // true : Kafkaê°€ ì£¼ê¸°ì ìœ¼ë¡œ ìë™ìœ¼ë¡œ ì»¤ë°‹(ìµœì‹  ë©”ì‹œì§€ë§Œ ì²˜ë¦¬í•˜ë ¤ëŠ” ê²½ìš°ì—ëŠ” ìœ ë¦¬)
        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, true);

        //Kafkaì— í˜„ì¬ consumer groupì— í•´ë‹¹í•˜ëŠ” offsetì´ ì—†ì„ ë•Œ ì–´ë””ì„œë¶€í„° ë©”ì‹œì§€ë¥¼ ì½ì„ì§€ë¥¼ ê²°ì •
        //earliest : ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ë¶€í„° ë‹¤ì‹œ ì½ê¸° ì‹œì‘ / latest : ê°€ì¥ ìµœê·¼ ë©”ì‹œì§€ë¶€í„° ì½ê¸° ì‹œì‘
        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");

        //í•œë²ˆì— ìµœëŒ€ 10ê°œë§Œ consume
        props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 10);

        JsonDeserializer<T> jsonDeserializer = new JsonDeserializer<>(clazz);
        jsonDeserializer.addTrustedPackages("*");

        return new DefaultKafkaConsumerFactory<>(props, new StringDeserializer(), jsonDeserializer);
    }
    
    @Bean
    public ConsumerFactory<String, SeatBookedEvent> seatBookedConsumerFactory() {
      return consumerFactory(SeatBookedEvent.class, "concert-consumer-group");
    }
    
}
```

| ì„¤ì • í‚¤                        | ì„¤ëª…                                                               |
|-------------------------------|--------------------------------------------------------------------|
| BOOTSTRAP_SERVERS_CONFIG      | Kafka ë¸Œë¡œì»¤ ì£¼ì†Œ                                                   |
| GROUP_ID_CONFIG               | Consumerê°€ ì†í•  Group ID                                           |
| KEY_DESERIALIZER_CLASS_CONFIG | ë©”ì‹œì§€ Key ì—­ì§ë ¬í™” í´ë˜ìŠ¤                                         |
| VALUE_DESERIALIZER_CLASS_CONFIG | ë©”ì‹œì§€ Value ì—­ì§ë ¬í™” í´ë˜ìŠ¤                                    |
| ENABLE_AUTO_COMMIT_CONFIG     | ìë™ ì˜¤í”„ì…‹ ì»¤ë°‹ ì—¬ë¶€ (`true`: ì£¼ê¸°ì ìœ¼ë¡œ ìë™ ì»¤ë°‹)              |
| AUTO_OFFSET_RESET_CONFIG      | ì˜¤í”„ì…‹ì´ ì—†ì„ ê²½ìš° ì½ê¸° ì‹œì‘ ìœ„ì¹˜ (`earliest`: ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ë¶€í„°) |
| MAX_POLL_RECORDS_CONFIG       | í•œ ë²ˆì— ê°€ì ¸ì˜¬ ìµœëŒ€ ë©”ì‹œì§€ ìˆ˜ (`10`)                              |


## ğŸ“Œ2-2. ì¹´í”„ì¹´ ê¸°ë³¸ ê¸°ëŠ¥ ìˆ˜í–‰
ì½˜ì„œíŠ¸ ì˜ˆì•½ í›„ ì¢Œì„ ì ìœ  ì´ë²¤íŠ¸ ê¸°ë°˜ ê¸°ë³¸ ê¸°ëŠ¥ êµ¬í˜„

í•´ë‹¹ ê¸°ëŠ¥ì€ Kafkaë¥¼ í†µí•´ ì¢Œì„ ì ìœ  ì´ë²¤íŠ¸ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤. 
ProducerëŠ” ì½˜ì„œíŠ¸ IDë¥¼ ë©”ì‹œì§€ Keyë¡œ ì‚¬ìš©í•´ Kafka Topic (`seat-booked-topic`)ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê³ , ì´ Keyë¥¼ ê¸°ë°˜ìœ¼ë¡œ KafkaëŠ” ë‚´ë¶€ í•´ì‹œ ì „ëµì— ë”°ë¼ 3ê°œì˜ íŒŒí‹°ì…˜ ì¤‘ í•˜ë‚˜ì— ë©”ì‹œì§€ë¥¼ í• ë‹¹í•œë‹¤.

í•´ë‹¹ íŒŒí‹°ì…˜ì€ Consumer Group(`concert-consumer-group`) ë‚´ì˜ Consumer ì¸ìŠ¤í„´ìŠ¤ê°€ 1:1ë¡œ ì²˜ë¦¬í•˜ë©°,
ì´ë¥¼ í†µí•´ ë©”ì‹œì§€ ìˆœì„œ ë³´ì¥(ê°™ì€ ì½˜ì„œíŠ¸ IDëŠ” ê°™ì€ íŒŒí‹°ì…˜ì— ì €ì¥), ë³‘ë ¬ ì²˜ë¦¬ ì„±ëŠ¥ í™•ë³´(íŒŒí‹°ì…˜ ë¶„ì‚° ì²˜ë¦¬) ë“± Kafkaì˜ ê¸°ë³¸ ê¸°ëŠ¥ì´ ì˜ í™œìš©ë˜ë„ë¡ êµ¬ì„±í•œë‹¤.

![ì¹´í”„ì¹´_ì¢Œì„ì ìœ ì´ë²¤íŠ¸_íë¦„ë„.png](ì¹´í”„ì¹´_ì¢Œì„ì ìœ ì´ë²¤íŠ¸_íë¦„ë„.png)
- Kafka í† í”½: seat_booked_topic
- íŒŒí‹°ì…˜ ìˆ˜: 3ê°œ
- ë©”ì‹œì§€ ë¶„ë°° ê¸°ì¤€: Concert IDë¥¼ keyë¡œ ì‚¬ìš©í•´ì„œ Kafkaì˜ ë‚´ë¶€ í•´ì‹œ ì „ëµì— ë”°ë¼ ìë™ ë¶„ë°°

### Kafkaì˜ íŒŒí‹°ì…˜-ì»¨ìŠˆë¨¸ ë§¤í•‘ ì›ì¹™ ì •ë¦¬
1. ë™ì¼ consumer group ë‚´ì—ì„œ, ê° íŒŒí‹°ì…˜ì€ ì˜¤ì§ í•˜ë‚˜ì˜ ì»¨ìŠˆë¨¸ ì¸ìŠ¤í„´ìŠ¤ë§Œ ì²˜ë¦¬ ê°€ëŠ¥(1:1) / í•˜ë‚˜ì˜ ì»¨ìŠˆë¨¸ëŠ” ì—¬ëŸ¬ íŒŒí‹°ì…˜ì„ ë§¡ì„ ìˆ˜ ìˆìŒ (1:N)
2. ì»¨ìŠˆë¨¸ ìˆ˜ == íŒŒí‹°ì…˜ ìˆ˜ì¼ ê²½ìš° ì¼ë°˜ì ìœ¼ë¡œ 1:1ë¡œ ë§¤ì¹­
- í•˜ì§€ë§Œ ì–´ë–¤ ì»¨ìŠˆë¨¸ê°€ ì–´ë–¤ íŒŒí‹°ì…˜ì„ ë°›ì„ì§€ëŠ” Kafkaê°€ ë‚´ë¶€ì ìœ¼ë¡œ ë¦¬ë°¸ëŸ°ì‹± í•˜ë©° ê²°ì •
- ì¦‰, íŒŒí‹°ì…˜ 0ì€ í•­ìƒ consumer-0ì—ê²Œ ê°„ë‹¤ ê°™ì€ ë³´ì¥ì€ ì—†ìŒ
3. ì»¨ìŠˆë¨¸ê°€ ì¬ì‹œì‘ë˜ê±°ë‚˜ ìˆ˜ê°€ ë°”ë€Œë©´ KafkaëŠ” ìë™ìœ¼ë¡œ **ë¦¬ë°¸ëŸ°ì‹±(rebalancing)**ì„ ìˆ˜í–‰í•˜ê³ , íŒŒí‹°ì…˜ í• ë‹¹ì„ ì¬ë¶„ë°°
- ì´ ê³¼ì •ì€ Kafkaê°€ Zookeeperë‚˜ Kafka ìì²´ì˜ group coordinatorë¥¼ í†µí•´ ì¡°ìœ¨

### ì½”ë“œ êµ¬í˜„

```java
/*
 ì¢Œì„ ì ìœ  ì²˜ë¦¬ ì´ë²¤íŠ¸ ë°œí–‰ -> ê¸°ì¡´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ë²¤íŠ¸ ê¸°ë°˜ì—ì„œ ì¹´í”„ì¹´ ì´ë²¤íŠ¸ ë°œí–‰ìœ¼ë¡œ ë³€ê²½
*/
bookingEventPublisher.success(new SeatBookedEvent(seat, seat.getConcertSeat()));
```

```java
/*
    ì¹´í”„ì¹´ publisherì—ì„œ ì´ë²¤íŠ¸ send
*/
@Component
@RequiredArgsConstructor
@Slf4j
public class KafkaBookingEventPublisher implements BookingEventPublisher {

    private final KafkaTemplate<String, Object> kafkaTemplate;
    private static final String SEAT_BOOKED_TOPIC = "seat-booked-topic";

    @Override
    public void success(SeatBookedEvent event) {

        //key ê°’ì— ë”°ë¼ ë©”ì‹œì§€ê°€ ê°ê¸° ë‹¤ë¥¸ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¶„ë°°ë˜ê²Œ. (ì½˜ì„œíŠ¸ ë³„ë¡œ key êµ¬ì„± -> ìë™ìœ¼ë¡œ kafkaTemplateì´ hash ë³€í™˜)
        //kafkaTemplate.send(SEAT_BOOKED_TOPIC, key, event);
        String key = String.valueOf(event.getSeat().getConcertSeat().getConcert().getConcertId());
        kafkaTemplate.send(SEAT_BOOKED_TOPIC, key, event);
        log.info("-----Kafka sent SeatBookedEvent with key={} : {}-----", key, event);
    }
}
```

```java
/*
    ì¹´í”„ì¹´ consumer listener í†µí•´ ë°œí–‰ ì´ë²¤íŠ¸ ìˆ˜í–‰
*/
@Component
@RequiredArgsConstructor
@Slf4j
public class SeatBookedKafkaConsumer {

    private final SeatRepository seatRepository;

    @KafkaListener(topics = "seat-booked-topic", groupId = "concert-consumer-group", containerFactory = "seatBookedListenerContainerFactory")
    @Transactional
    public void consumeSeatBookedEvent(SeatBookedEvent event) {
        try {
            log.info("-----Kafka Consumer received SeatBookedEvent: {} -----", event);

            Seat seat = event.getSeat();
            seat.setSeatStatus(SeatStatus.OCCUPIED);
            seat.setConcertSeat(event.getConcertSeat());
            seatRepository.save(seat);

        } catch (SeatException e) {
            log.error("Error handling SeatBookedEvent: {}", e.getStatus(), e);
            throw e;
        }
    }
}
```


# âœï¸3. ê²°ë¡ 
Kafkaë¥¼ ë„ì…í•¨ìœ¼ë¡œì¨ ì‹œìŠ¤í…œì€ ë©”ì‹œì§€ ê¸°ë°˜ì˜ ë¹„ë™ê¸° êµ¬ì¡°ë¡œ ì „í™˜ë˜ì—ˆê³ , ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ Kafkaë¥¼ í™œìš©í•´ ë©”ì‹œì§€ì˜ ë°œí–‰ê³¼ ì†Œë¹„ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í•˜ì˜€ë‹¤.

KafkaëŠ” íŒŒí‹°ì…”ë‹ê³¼ Consumer Group êµ¬ì¡°ë¥¼ í†µí•´ ëŒ€ê·œëª¨ ì´ë²¤íŠ¸ì˜ ë³‘ë ¬ ì²˜ë¦¬ì™€ ë©”ì‹œì§€ ìˆœì„œ ë³´ì¥ì„ ë™ì‹œì— ë‹¬ì„±í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ì œê³µí•˜ë©°, ì´ë¥¼ í†µí•´ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹œìŠ¤í…œì˜ í™•ì¥ì„±ê³¼ ì‹ ë¢°ì„±ì„ íš¨ê³¼ì ìœ¼ë¡œ í™•ë³´í•  ìˆ˜ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤.