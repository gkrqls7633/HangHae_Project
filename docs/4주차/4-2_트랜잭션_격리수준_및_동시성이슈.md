# 1. νΈλμ­μ… κ²©λ¦¬ μμ¤€ λ° λ™μ‹μ„± μ΄μ

##  π“ νΈλμ­μ… κ²©λ¦¬ μμ¤€

### νΈλμ­μ… κ²©λ¦¬ μμ¤€μ΄λ€?
- νΈλμ­μ…μ΄ λ™μ‹μ— μ‹¤ν–‰λ  λ• λ°μ΄ν„° μΌκ΄€μ„±μ„ μ–Όλ§λ‚ λ³΄μ¥ν• μ§€ κ²°μ •ν•λ” μμ¤€.
- κ²©λ¦¬ μμ¤€μ΄ λ†’μ„μλ΅ μΌκ΄€μ„±μ€ μΆ‹μ•„μ§€μ§€λ§ μ„±λ¥μ€ λ–¨μ–΄μ§. λ°λ€λ΅ λ‚®μ„μλ΅ μ„±λ¥μ€ μΆ‹μ§€λ§ λ™μ‹μ„± λ¬Έμ κ°€ μƒκΈΈ μ  μμ.

### π“ νΈλμ­μ… κ²©λ¦¬ μμ¤€ μ •λ¦¬ν‘

| κ²©λ¦¬ μμ¤€           | Dirty Read | Non-Repeatable Read | Phantom Read      | μ„±λ¥     | κΈ°λ³Έκ°’ (MySQL) |
|--------------------|------------|----------------------|-------------------|----------|----------------|
| Read Uncommitted   | β… λ°μƒ     | β… λ°μƒ               | β… λ°μƒ              | π”¥ λΉ λ¦„  | β              |
| Read Committed     | β μ°¨λ‹¨     | β… λ°μƒ               | β… λ°μƒ              | π€ μΆ‹μ  | β              |
| Repeatable Read    | β μ°¨λ‹¨     | β μ°¨λ‹¨               | β… λ°μƒ (MySQLκΈ°μ¤€ λ°©μ§€) | π™‚ λ³΄ν†µ  | β… κΈ°λ³Έκ°’       |
| Serializable       | β μ°¨λ‹¨     | β μ°¨λ‹¨               | β μ°¨λ‹¨              | πΆ λλ¦Ό  | β              |

---
### κ° κ²©λ¦¬ μμ¤€ μ‹¤ν— λ‚΄μ©
- Read Uncommitted : Dirty Read μ‹¤ν—
  - νΈλμ­μ… Aκ°€ μ»¤λ°‹ μ• ν• λ°μ΄ν„°λ¥Ό νΈλμ­μ… Bκ°€ μ½λ”μ§€ ν™•μΈ
- Read Committed
  - νΈλμ­μ… Aμ—μ„ λ‘ λ² μ½μ„ λ•, μ¤‘κ°„μ— Bκ°€ μμ •ν• κ°’μ΄ λ³΄μ΄λ”μ§€ ν™•μΈ
- Repeatable Read
  - νΈλμ­μ… Aμ—μ„ μ΅°κ±΄μ— λ§λ” rowλ¥Ό μ΅°νν• λ’¤, νΈλμ­μ… Bκ°€ row μ‚½μ… μ‹ Aμ— μν–¥μ„ λ―ΈμΉλ”μ§€ ν™•μΈ
- Serializable
  - λ¨λ“  λ™μ‹μ„± μ΄μκ°€ λ§‰νλ”μ§€ ν™•μΈ(Lock ν™•μΈ ν¬ν•¨)

# 2. κ²©λ¦¬ μμ¤€ μ‹¤ν— - Read κ³„μ—΄ λΉ„κµ

| κ²©λ¦¬ μ΄μ              | μμ‹                                 | λ°μƒ μ΅°κ±΄                                   | λ°©μ§€λλ” κ²©λ¦¬ μμ¤€             |
|---------------------|------------------------------------|-----------------------------------------|---------------------------|
| **Dirty Read**       | Aκ°€ μ•„μ§ μ»¤λ°‹ μ•ν• λ°μ΄ν„° Bκ°€ μ½μ         | μ»¤λ°‹ μ•ν• λ°μ΄ν„° μ΅°ν                            | Read Committed μ΄μƒ          |
| **Non-Repeatable Read** | Aκ°€ κ°™μ€ λ°μ΄ν„°λ¥Ό λ‘ λ² μ΅°νν–λ”λ° κ°’μ΄ λ‹¤λ¦„ | μ¤‘κ°„μ— Bκ°€ μμ •                                      | Repeatable Read μ΄μƒ        |
| **Phantom Read**     | Aκ°€ μ΅°κ±΄ μ΅°νλ¥Ό λ‘ λ² ν–λ”λ° κ²°κ³Ό row μκ°€ λ‹¬λΌμ§ | μ¤‘κ°„μ— Bκ°€ insert                                      | **Serializableλ§ μ™„μ „ λ°©μ§€**  |


### κ° κ²©λ¦¬ μμ¤€μ—μ„ λ°μƒν•  μ μλ” λ™μ‹μ„± μ΄μ μ •λ¦¬
- Dirty Read  
  μ»¤λ°‹λμ§€ μ•μ€ λ°μ΄ν„°λ¥Ό λ‹¤λ¥Έ νΈλμ­μ…μ΄ μ½λ” ν„μƒ

- Non-Repeatable Read
  κ°™μ€ λ°μ΄ν„°λ¥Ό λ‘ λ² μ½μ„ λ•, μ¤‘κ°„μ— κ°’μ΄ λ³€κ²½λμ–΄ λ‹¤λ¥Έ κ²°κ³Όκ°€ λ‚μ¤λ” ν„μƒ

- Phantom Read  
  μ΅°κ±΄μ— λ§λ” λ°μ΄ν„°λ¥Ό μ΅°νν–μ„ λ•, μ¤‘κ°„μ— μƒλ΅μ΄ λ°μ΄ν„°κ°€ μ¶”κ°€λμ–΄ κ²°κ³Όκ°€ λ‹¬λΌμ§€λ” ν„μƒ


### π“ μ°Έκ³ 
- MySQL(InnoDB)μ κΈ°λ³Έ κ²©λ¦¬ μμ¤€μ€ `Repeatable Read`
- μ„±λ¥κ³Ό μ •ν•©μ„±μ€ νΈλ μ΄λ“μ¤ν”„ κ΄€κ³„μ΄λ―€λ΅ μƒν™©μ— λ§λ” μ„ νƒμ΄ μ¤‘μ”

---

# 3. κ²©λ¦¬ μμ¤€ λ³„ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤ κµ¬ν„
## π“ **Read Uncommitted : Drity Read ν…μ¤νΈ**

## π― **λ©ν‘**
- **Dirty Read**λ¥Ό ν…μ¤νΈν•κΈ° μ„ν•΄ **Read Uncommitted** κ²©λ¦¬ μμ¤€μ„ μ‚¬μ©ν•μ—¬ νΈλμ­μ… κ°„μ λ™μ‹μ„± λ¬Έμ λ¥Ό ν™•μΈν•λ‹¤.
- ν…μ¤νΈλ” λ‘ κ°μ νΈλμ­μ…(A, B)μ„ λ™μ‹μ— μ‹¤ν–‰ν•μ—¬, νΈλμ­μ… Aκ°€ μ»¤λ°‹λμ§€ μ•μ€ μƒνƒμ—μ„ νΈλμ­μ… Bκ°€ λ°μ΄ν„°λ¥Ό μ½μ„ μ μλ”μ§€ κ²€μ¦ν•λ‹¤.

## βοΈ **ν…μ¤νΈ μ‹λ‚λ¦¬μ¤**

1. **νΈλμ­μ… A**λ” μ‚¬μ©μμ ν¬μΈνΈλ¥Ό μμ •ν•κ³ , λ³€κ²½λ κ°’μ€ μ»¤λ°‹λμ§€ μ•μ€ μƒνƒμ—μ„ 2μ΄ λ™μ• λ€κΈ°ν•λ‹¤.
2. **νΈλμ­μ… B**λ” νΈλμ­μ… Aκ°€ μ‹μ‘λ ν›„, Aκ°€ μ»¤λ°‹λκΈ° μ „μ— ν•΄λ‹Ή ν¬μΈνΈλ¥Ό μ½κ³  λ³€κ²½λ κ°’μ„ ν™•μΈν•λ‹¤.
3. νΈλμ­μ… Aκ°€ μ»¤λ°‹λκΈ° μ „μ— νΈλμ­μ… Bλ” μ½μ„ μ μλ”μ§€ ν™•μΈν•μ—¬ **Dirty Read**κ°€ λ°μƒν–λ”μ§€ ν™•μΈν•λ‹¤.

## **ν…μ¤νΈ νλ¦„**
### 1. **Test Setup**
- **ν…μ¤νΈμ© λ°μ΄ν„° μ¤€λΉ„**:
  - ν…μ¤νΈμ© μ‚¬μ©μ(`User`)μ™€ κ·Έμ— μ—°κ΄€λ ν¬μΈνΈ(`Point`)λ¥Ό λ°μ΄ν„°λ² μ΄μ¤μ— μ €μ¥ν•λ‹¤.
  - νΈλμ­μ… Aμ—μ„ μ‚¬μ©ν•λ” μ‚¬μ©μ ID(`savedUserId`)λ¥Ό μ €μ¥ν•λ‹¤.

### 2. **νΈλμ­μ… A: ν¬μΈνΈ μμ •**
- νΈλμ­μ… Aλ” **Read Uncommitted** κ²©λ¦¬ μμ¤€μ—μ„ μ‹¤ν–‰λλ‹¤.
- νΈλμ­μ… Aλ” ν¬μΈνΈλ¥Ό 100 μ¦κ°€μ‹ν‚¨ ν›„, μ»¤λ°‹λμ§€ μ•μ€ μƒνƒλ΅ 2μ΄ λ™μ• λ€κΈ°ν•λ‹¤.
- νΈλμ­μ… Aκ°€ μ»¤λ°‹λκΈ° μ „, νΈλμ­μ… Bκ°€ ν•΄λ‹Ή ν¬μΈνΈλ¥Ό μ½μ„ μ μλ”μ§€ ν™•μΈν•λ‹¤.

```java
@Transactional(isolation = Isolation.READ_UNCOMMITTED)
public void transactionA(Long userId) throws InterruptedException {
    Point point = pointRepository.findById(userId)
            .orElseThrow(() -> new RuntimeException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));
    
    point.setPointBalance(point.getPointBalance() + 10000);  // ν¬μΈνΈ μ¦κ°€
    pointRepository.save(point);  // μ»¤λ°‹λμ§€ μ•μ€ μƒνƒλ΅ μμ •

    System.out.println("π“ νΈλμ­μ… A: ν¬μΈνΈ μμ • μ™„λ£ (μ»¤λ°‹ μ „)");
    
    // 2μ΄ λ€κΈ° ν›„ μ»¤λ°‹
    Thread.sleep(2000);  

    System.out.println("β… νΈλμ­μ… A μΆ…λ£ (μ»¤λ°‹)");
}

@Transactional(isolation = Isolation.READ_UNCOMMITTED)
public void transactionB(Long userId) {
    Point point = pointRepository.findById(userId)
            .orElseThrow(() -> new RuntimeException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));
    
    System.out.println("π‘€ νΈλμ­μ… Bκ°€ μ½μ€ ν¬μΈνΈ μ”μ•΅: " + point.getPointBalance());
}
``` 

``` 
<μµμΆ… λ΅κ·Έ κ²°κ³Ό>
νΈλμ­μ… A: ν¬μΈνΈ μμ • μ™„λ£ (μ»¤λ°‹ μ „)
νΈλμ­μ… Bκ°€ μ½μ€ ν¬μΈνΈ μ”μ•΅: 200,000  -> Dirty Read λ°μƒ!!  (μλ„λ” 205,000μΈλ° MySQL( InnoDB)λ” READ UNCOMMITTED μ§€μ •ν•΄λ„ λ‚΄λ¶€μ μΌλ΅λ” Dirty Readλ¥Ό κ±°μ ν—μ©ν•μ§€ μ•μ.)
νΈλμ­μ… A μΆ…λ£ (μ»¤λ°‹)
``` 

---

## π“ **Read Committed**
## π― **λ©ν‘**
- **Dirty Read**κ°€ λ°μƒν•μ§€ μ•μμ„ ν™•μΈν•κΈ° μ„ν•΄ **Read Committed** κ²©λ¦¬ μμ¤€μ„ μ‚¬μ©ν•λ” νΈλμ­μ… κ°„ λ™μ‹μ„± ν…μ¤νΈλ¥Ό μν–‰ν•λ‹¤.
- νΈλμ­μ… Aκ°€ μ»¤λ°‹λμ§€ μ•μ€ μƒνƒμ—μ„ νΈλμ­μ… Bκ°€ λ™μΌ λ°μ΄ν„°λ¥Ό μ½μ„ μ μλ”μ§€λ¥Ό ν™•μΈν•μ—¬ **Dirty Read λ°©μ§€ μ—¬λ¶€**λ¥Ό κ²€μ¦ν•λ‹¤.

## βοΈ **ν…μ¤νΈ μ‹λ‚λ¦¬μ¤**

1. **νΈλμ­μ… A**λ” μ‚¬μ©μ ν¬μΈνΈλ¥Ό μμ •ν• ν›„, **μ»¤λ°‹ν•μ§€ μ•κ³  2μ΄κ°„ λ€κΈ°**ν•λ‹¤.
2. **νΈλμ­μ… B**λ” νΈλμ­μ… Aκ°€ **μ»¤λ°‹λκΈ° μ „**, λ™μΌ ν¬μΈνΈ λ°μ΄ν„°λ¥Ό μ΅°νν•λ‹¤.
3. νΈλμ­μ… Bκ°€ **λ³€κ²½λ λ°μ΄ν„°λ¥Ό μ½μ§€ λ»ν•κ³ **, κΈ°μ΅΄ λ°μ΄ν„°λ¥Ό μ΅°νν•΄μ•Ό ν…μ¤νΈ μ„±κ³µμΌλ΅ κ°„μ£Όν•λ‹¤.

## **ν…μ¤νΈ νλ¦„**
### 1. **Test Setup**
- **ν…μ¤νΈμ© λ°μ΄ν„° μ¤€λΉ„**:
  - ν…μ¤νΈμ© Userμ™€ Pointλ¥Ό μƒμ„±ν•λ‹¤.
  - ν…μ¤νΈ λ©”μ„λ“ μ‹μ‘ μ „ DBμ— λ°μ΄ν„° μ €μ¥ λ° μ»¤λ°‹ μ™„λ£

### 2. **νΈλμ­μ… A: ν¬μΈνΈ μμ •**
- κ²©λ¦¬ μμ¤€: `READ_COMMITTED`
- λ™μ‘ λ‚΄μ©:
  - ν¬μΈνΈ `+5000` μ¦κ°€ (`205000`)
  - DBμ— μ»¤λ°‹μ€ ν•μ§€ μ•μ
  - 2μ΄κ°„ λ€κΈ°ν•μ—¬ νΈλμ­μ… Bκ°€ μ΅°νν•  μ μλ„λ΅ μ λ„

```java
@Transactional(isolation = Isolation.READ_COMMITTED)
public void readCommittedTransactionA(Long userId) throws InterruptedException {
  // ν¬μΈνΈ μ΅°ν
  Point point = pointRepository.findById(userId)
          .orElseThrow(() -> new RuntimeException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));

  point.setPointBalance(point.getPointBalance() + 5000L);  // ν¬μΈνΈ μ¦κ°€
  pointRepository.save(point);  // μ»¤λ°‹λμ§€ μ•μ€ μƒνƒλ΅ μμ •

  System.out.println("###### νΈλμ­μ… A: ν¬μΈνΈ μμ • μ™„λ£ (μ»¤λ°‹ μ „)");
  // 2μ΄ λ€κΈ° ν›„ μ»¤λ°‹
  Thread.sleep(2000); // Bκ°€ μ΄ μ‚¬μ΄μ— μ½λ„λ΅ μ λ„
  System.out.println("###### νΈλμ­μ… A μΆ…λ£ (μ»¤λ°‹)");
}

@Transactional(isolation = Isolation.READ_COMMITTED)
public void readCommittedTransactionB(Long userId) {
  // νΈλμ­μ… Aμ—μ„ μ»¤λ°‹λ λ°μ΄ν„°λ¥Ό μ½μ„ μ μλ”μ§€ ν™•μΈ
  Point point = pointRepository.findById(userId)
          .orElseThrow(() -> new RuntimeException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));

  System.out.println("###### νΈλμ­μ… Bκ°€ μ½μ€ ν¬μΈνΈ μ”μ•΅: " + point.getPointBalance());
}
``` 

``` 
<μµμΆ… λ΅κ·Έ κ²°κ³Ό>
π“ νΈλμ­μ… A: ν¬μΈνΈ μμ • μ™„λ£ (μ»¤λ°‹ μ „)
π‘€ νΈλμ­μ… Bκ°€ μ½μ€ ν¬μΈνΈ μ”μ•΅: 200,000 -> AνΈλμ­μ…μ΄ μ»¤λ°‹λκΈ° μ „ λ°μ΄ν„°λ¥Ό μ΅°νν•¨.
β… νΈλμ­μ… A μΆ…λ£ (μ»¤λ°‹)
``` 

---

## π“ **Repeatable Read**
## π― **λ©ν‘**
- λ™μΌ νΈλμ­μ… λ‚΄μ—μ„ λ™μΌν• λ°μ΄ν„°λ¥Ό μ—¬λ¬ λ² μ΅°νν•  λ• **μΌκ΄€λ κ²°κ³Όκ°€ λ°ν™λλ”μ§€ κ²€μ¦**ν•λ‹¤.
- νΈλμ­μ… Aκ°€ ν¬μΈνΈ λ°μ΄ν„°λ¥Ό λ‘ λ² μ΅°νν•κ³ , κ·Έ μ‚¬μ΄ νΈλμ­μ… Bκ°€ κ°’μ„ μμ •ν•λ” μ‹λ‚λ¦¬μ¤λ¥Ό ν†µν•΄ **Repeatable Read** κ²©λ¦¬ μμ¤€μ νΉμ„±μ„ ν…μ¤νΈν•λ‹¤.

## βοΈ **ν…μ¤νΈ μ‹λ‚λ¦¬μ¤**

1. **νΈλμ­μ… A**λ” ν¬μΈνΈλ¥Ό ν• λ² μ΅°νν• λ’¤, **2μ΄κ°„ λ€κΈ°** ν›„ λ‹¤μ‹ κ°™μ€ λ°μ΄ν„°λ¥Ό μ΅°νν•λ‹¤.
2. **νΈλμ­μ… B**λ” Aμ μ²« μ΅°ν μ΄ν›„ λ°μ΄ν„°λ¥Ό **μμ •ν•κ³  μ»¤λ°‹**ν•λ‹¤.
3. Aμ λ‘ λ²μ§Έ μ΅°ν μ‹ κ°’μ΄ **μ²μκ³Ό λ™μΌν•λ©΄ Repeatable Read λ³΄μ¥**, **λ‹¬λΌμ΅λ‹¤λ©΄ κΉ¨μ§**.

## **ν…μ¤νΈ νλ¦„**
### 1. **Test Setup**

- **μ΄κΈ° λ°μ΄ν„°**
  - ν¬μΈνΈ μ”μ•΅: `200000`
  - μ‚¬μ©μ ID: `savedUserId`μ— μ €μ¥
  - νΈλμ­μ… Aμ™€ Bλ” ν•΄λ‹Ή μ‚¬μ©μ IDλ΅ μ΅°ν λ° μμ •

### 2. **νΈλμ­μ… A: λ‘ λ² μ΅°ν**

- κ²©λ¦¬ μμ¤€: `REPEATABLE_READ`
- μν–‰ λ‚΄μ©:
  1. ν¬μΈνΈ **μ²« μ΅°ν**
  2. νΈλμ­μ… B μ‹¤ν–‰μ„ μ λ„ (`CountDownLatch`)
  3. 2μ΄ ν›„ **λ‘ λ²μ§Έ μ΅°ν**
  4. λ‘ μ΅°ν κ²°κ³Ό λΉ„κµ

```java
@Transactional(isolation = Isolation.REPEATABLE_READ)
public void repeatableReadTransactionA(Long userId, CountDownLatch latch) throws InterruptedException {
  Point point1 = pointRepository.findById(userId)
          .orElseThrow(() -> new RuntimeException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));

  System.out.println("π” [A] μ²« μ΅°ν: " + point1.getPointBalance());
  latch.countDown(); // B μ‹¤ν–‰ μ‹μ‘ μ•λ¦Ό

  Thread.sleep(2000); // Bκ°€ μ¤‘κ°„μ— μμ •ν•λ„λ΅ λ€κΈ°

  Point point2 = pointRepository.findById(userId)
          .orElseThrow(() -> new RuntimeException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));
  System.out.println("π” [A] λ‘ λ²μ§Έ μ΅°ν: " + point2.getPointBalance());

  if (point1.getPointBalance().equals(point2.getPointBalance())) {
    System.out.println("β… Repeatable Read λ³΄μ¥λ¨: λ‘ μ΅°ν κ²°κ³Ό λ™μΌ");
  } else {
    System.out.println("β Repeatable Read κΉ¨μ§: κ°’μ΄ λ‹¬λΌμ§");
  }
}

@Transactional
public void repeatableReadTransactionB(Long userId) {
  Point point = pointRepository.findById(userId)
          .orElseThrow(() -> new RuntimeException("ν¬μΈνΈ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤."));

  point.setPointBalance(point.getPointBalance() + 10000);
  pointRepository.save(point);
  pointRepository.flush();
  System.out.println("βοΈ [B] ν¬μΈνΈ μμ • λ° μ»¤λ°‹ μ™„λ£");
}
``` 

``` 
<μµμΆ… λ΅κ·Έ κ²°κ³Ό>
[A] μ²« μ΅°ν: 200000
[B] ν¬μΈνΈ μμ • λ° μ»¤λ°‹ μ™„λ£
[A] λ‘ λ²μ§Έ μ΅°ν: 200000
Repeatable Read λ³΄μ¥λ¨: λ‘ μ΅°ν κ²°κ³Ό λ™μΌ
``` 

---

## π“ **Serializable**
## π― **λ©ν‘**
- **Serializable κ²©λ¦¬ μμ¤€**μ€ κ°€μ¥ κ°•λ ¥ν• νΈλμ­μ… κ²©λ¦¬ μμ¤€μΌλ΅, λ¨λ“  μΆ…λ¥μ λ™μ‹μ„± λ¬Έμ λ¥Ό λ°©μ§€ν•λ‹¤.
- μ΄ μ‹¤ν—μ—μ„λ” **νΈλμ­μ… κ°„μ λ™μ‹ λ°μ΄ν„° μμ • λ° Phantom Read λ°μƒ κ°€λ¥μ„±**μ„ μ°¨λ‹¨ν•λ”μ§€λ¥Ό κ²€μ¦ν•λ‹¤.

## βοΈοΈ **ν…μ¤νΈ μ‹λ‚λ¦¬μ¤**

1. **νΈλμ­μ… A**λ” μ‚¬μ©μ ν¬μΈνΈλ¥Ό `user_id`λ΅ μ΅°νν• ν›„ μΌμ • μ‹κ°„ λ€κΈ° ν›„ μΆ…λ£ν•λ‹¤.(μ»¤λ°‹)

2. λ™μΌν• `user_id`λ¥Ό μ΅°ν ν›„ **ν¬μΈνΈλ¥Ό μμ •** ν›„ νΈλμ­μ… Aκ°€ μΆ…λ£λκΈ° μ „κΉμ§€ **λ€κΈ°(blocking)** μƒνƒκ°€ λ°μƒν•λ”μ§€ ν™•μΈν•λ‹¤.

```java
// νΈλμ­μ… A: ν¬μΈνΈ μ΅°ν ν›„ λ€κΈ°
// READ_COMMITTEDλ” Phantom Read λ°μƒν•  μ μμ.
@Transactional(isolation = Isolation.READ_COMMITTED)
public List<Point> readPointsGreaterThanEqual(Long amount) throws InterruptedException {
  // μ΅°κ±΄μ— λ§λ” ν¬μΈνΈ μ΅°ν
  List<Point> points = pointRepository.findByPointBalanceGreaterThanEqual(amount);
  System.out.println("π”’ [A] μ²« λ²μ§Έ μ΅°ν κ²°κ³Ό: " + points.size());

  // μ μ‹ λ€κΈ°ν•μ—¬ νΈλμ­μ… Bκ°€ μ‚½μ…ν•  μ‹κ°„μ„ μ¤
  Thread.sleep(2000);  // 2μ΄ λ€κΈ° ν›„ λ‹¤μ‹ μ΅°ν

  points = pointRepository.findByPointBalanceGreaterThanEqual(amount);  // λ‘ λ²μ§Έ μ΅°ν
  System.out.println("π”’ [A] λ‘ λ²μ§Έ μ΅°ν κ²°κ³Ό: " + points.size());

  return points;
}

// νΈλμ­μ… B: μƒλ΅μ΄ row μ‚½μ…
@Transactional(isolation = Isolation.READ_COMMITTED)
public void insertNewPoint(Long userId, Long pointBalance) {

  User user = new User();
  user.setUserName("κΉ€ν…μ¤νΈ");
  user.setPhoneNumber("010-1234-1234");
  user.setEmail("test2@naver.com");
  user.setAddress("μ„μΈνΉλ³„μ‹ κ°•μ„κµ¬ λ“±μ΄λ™");
  User savedUser = userRepository.save(user);

  Point point = new Point();
  point.setUser(savedUser);
  point.setPointBalance(200000L);
  pointRepository.save(point);
  System.out.println("βοΈ [B] μƒλ΅μ΄ row μ‚½μ… μ™„λ£");
}
``` 

``` 
<μµμΆ… λ΅κ·Έ κ²°κ³Ό>
[A] μ²« λ²μ§Έ μ΅°ν κ²°κ³Ό: 37
[B] μƒλ΅μ΄ row μ‚½μ… μ™„λ£
[A] λ‘ λ²μ§Έ μ΅°ν κ²°κ³Ό: 38  ----> Phantom Read λ°μƒ!!
``` 

---

# 4. Phantom Read μ‹¤ν— & ν•΄κ²° λ°©μ‹ (MVCC, Lock)

## π― κ°μ”
**Phantom Read**λ” νΈλμ­μ… μ¤‘ κ°™μ€ μ΅°κ±΄μΌλ΅ λ‘ λ² μ΅°νν–μ„ λ•, **μ¤‘κ°„μ— λ‹¤λ¥Έ νΈλμ­μ…μ΄ μƒλ΅μ΄ rowλ¥Ό μ‚½μ…ν•μ—¬ μ΅°ν κ²°κ³Όκ°€ λ‹¬λΌμ§€λ” ν„μƒ**μ΄λ‹¤.


## π”¬ μ‹¤ν— κ°μ”

### β–¶ μ‹¤ν— μ‹λ‚λ¦¬μ¤
- νΈλμ­μ… Aκ°€ `point_balance >= 100000` μ΅°κ±΄μΌλ΅ λ‘ λ² μ΅°νν•λ‹¤.
- μ²« μ΅°νμ™€ λ‘ λ²μ§Έ μ΅°ν μ‚¬μ΄, νΈλμ­μ… Bκ°€ ν•΄λ‹Ή μ΅°κ±΄μ„ λ§μ΅±ν•λ” rowλ¥Ό μ‚½μ…ν•λ‹¤.

### β–¶ μ‹¤ν— κ²°κ³Ό (MySQL κΈ°μ¤€)

| κ²©λ¦¬ μμ¤€         | Phantom Read λ°μƒ μ—¬λ¶€ | μ„¤λ…                            |
|------------------|--------------------|---------------------------------|
| Read Uncommitted | β… λ°μƒ               | λ¨λ“  λ°μ΄ν„° μ ‘κ·Ό ν—μ©           |
| Read Committed   | β… λ°μƒ -> ν•΄λ‹Ή ν…μ¤νΈ κµ¬ν„  | μ»¤λ°‹λ λ°μ΄ν„°λ§ μ½μ§€λ§ μ‚½μ… κ°μ§€ |
| Repeatable Read  | β λ°μƒ μ• ν•¨ (MySQL)   | Gap LockμΌλ΅ μ‚½μ… μ°¨λ‹¨          |
| Serializable     | β λ°μƒ μ• ν•¨           | μ™„μ „ν• μ§λ ¬ν™”λ΅ λ™μ‹μ„± λ¬Έμ  μ κ±° |

## π” ν•΄κ²° λ°©μ‹ λΉ„κµ

| λ°©μ‹             | μ„¤λ…                                                                 |
|------------------|----------------------------------------------------------------------|
| **MVCC**         | λ²„μ „ κΈ°λ° μ¤λƒ…μƒ·μ„ ν†µν•΄ νΈλμ­μ…λ§λ‹¤ μΌκ΄€λ μ½κΈ° μ κ³µ (PostgreSQL λ“±) |
| **Gap Lock**     | μΈλ±μ¤ μ‚¬μ΄ λ²”μ„μ— λ½μ„ κ±Έμ–΄ **μ‚½μ… μμ²΄λ¥Ό μ°¨λ‹¨** (MySQL InnoDB)     |
| **Serializable** | νΈλμ­μ… μ „μ²΄μ— λ½μ„ κ±Έμ–΄ λ¨λ“  κ²©λ¦¬ μ΄μ μ κ±° (μ„±λ¥ ν¬μƒ μμ)       |

## β… κ²°λ΅ 
- **Phantom Readλ” μ‚½μ…μ— μν• κ²°κ³Ό λ³€κ²½μ΄λ―€λ΅, λ‹¨μν• Row LockμΌλ΅λ” λ°©μ§€ν•  μ μ—†λ‹¤.**
- **MySQL**μ—μ„λ” Repeatable Readμ—μ„λ„ Gap Lock λ•λ¶„μ— λ°©μ§€λλ‹¤.
- **PostgreSQL**μ€ Serializable μ΄μƒ κ²©λ¦¬ μμ¤€μ„ μ‚¬μ©ν•΄μ•Ό μ™„μ „ λ°©μ§€ κ°€λ¥.
- μ •ν•©μ„±μ΄ μ¤‘μ”ν• μ‹μ μ—μ„λ” **Serializable** λλ” **μ• ν”λ¦¬μΌ€μ΄μ… λ‹¨ μλ‹¨** κ³ λ ¤ ν•„μ”.

### π“ μ°Έκ³ 
- DBMSλ§λ‹¤ λ™μ‘ μ°¨μ΄κ°€ μμ: MySQLμ€ Gap Lock μ‚¬μ©, PostgreSQLμ€ MVCC κΈ°λ°

---

# 5. @Transactional(propagation = ... ) λ€?
## π” propagation (νΈλμ­μ… μ „ν λ°©μ‹)

### β… μ •μ
- νΈλμ­μ…μ΄ **λ‹¤λ¥Έ νΈλμ­μ… λ‚΄μ—μ„ νΈμ¶λ  λ•μ λ™μ‘ λ°©μ‹**μ„ μ§€μ •

### π“‹ μ£Όμ” μ „ν μµμ…

| μµμ…               | μ„¤λ… |
|--------------------|------|
| `REQUIRED`         | ν„μ¬ νΈλμ­μ… μμΌλ©΄ μ°Έμ—¬, μ—†μΌλ©΄ μƒλ΅ μƒμ„± (**κΈ°λ³Έκ°’**) |
| `REQUIRES_NEW`     | ν•­μƒ **μƒλ΅μ΄ νΈλμ­μ… μƒμ„±**, κΈ°μ΅΄ νΈλμ­μ…μ€ **μΌμ‹ μ •μ§€** |
| `NESTED`           | ν„μ¬ νΈλμ­μ… λ‚΄μ— **μ¤‘μ²© νΈλμ­μ…** μƒμ„± (Rollbackμ€ λ…λ¦½μ ) |
| `SUPPORTS`         | νΈλμ­μ… μμΌλ©΄ μ°Έμ—¬, μ—†μΌλ©΄ νΈλμ­μ… μ—†μ΄ μ‹¤ν–‰ |
| `NOT_SUPPORTED`    | νΈλμ­μ… μ—†μ΄ μ‹¤ν–‰ (κΈ°μ΅΄ νΈλμ­μ… **μ¤‘λ‹¨**) |
| `NEVER`            | νΈλμ­μ…μ΄ μμΌλ©΄ μμ™Έ λ°μƒ |
| `MANDATORY`        | νΈλμ­μ… λ°λ“μ‹ μ΅΄μ¬ν•΄μ•Ό ν•¨ (μ—†μΌλ©΄ μμ™Έ λ°μƒ) |

---

