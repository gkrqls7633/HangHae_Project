# ADR Title: 성능 최적화 방안

## 📝 1. Context
현재 콘서트 예약 시스템 구축 과정에서 데이터 조회 성능이 저조한 기능 리스트업하여 개선하고자 함.

### 📌 대기열 서비스 개선사항

- 대기열 서비스에서 토큰 활성화 대상 조회할 때, 만료 시간과 토큰 상태에 따른 대상 조회 성능 개선 필요.
- 대기열 서비스에서 토큰 만료 대상을 조회할 때, 만료 시간과 상태에 따른 대기열 토큰 조회 성능 개선 필요.

### 📌 콘서트 서비스 개선사항
- 특정 콘서트의 예약 가능한 좌석을 조회할 때, seat 리스트를 가져오기 위한 join 설계 검토 필요.

---

## 📝 2. Ststus
- Accepted

### 목표
- 성능을 향상시키고, 대규모 데이터 조회 시 발생할 수 있는 병목 현상을 해소.

---

## 📝 3. Decision
### 📌 제안된 해결책
- Queue 테이블에 토큰 상태, 토큰 만료 시간에 대한 복합 인덱스를 추가하여 조회 성능을 개선
- Concert, Concert_Seat, Seat 간 연관관계 설계 재구성

### 📌 대안 후보

| 대안                           | 장점                                                                      | 단점                                                                                   |
|------------------------------|-------------------------------------------------------------------------|--------------------------------------------------------------------------------------|
| **대안 1**: 인덱스 추가             | - 조회 성능 향상 <br> - 간단한 구현 <br> - 데이터베이스 성능에 즉시 효과 <br> - 코드 변경 없이 DB 레벨에서 성능 향상 | - 추가된 인덱스가 성능을 저하시킬 수 있음 <br> - 추가된 인덱스가 디스크 공간을 차지함 <br> - 자주 변경되는 데이터에는 비효율적일 수 있음 |
| **대안 2**: 데이터 파티셔닝           | - 대용량 데이터 처리 시 성능 향상 <br> - 효율적인 데이터 분산 <br> - 특정 파티션을 별도로 관리 가능        | - 복잡한 데이터 관리 필요 <br> - 데이터 파티셔닝 설계와 관리가 어려움 <br> - 기존 시스템과의 호환성 문제 발생 가능             |
| **대안 3**: 캐싱                 | - 반복 조회 시 성능 향상 <br> - DB 부하 감소 <br> - 조회 시간을 크게 단축 가능                  | - 캐시의 만료 시간 관리 및 갱신 작업 필요 <br> - 데이터 일관성 문제 발생 가능 <br> - 캐시 장애 발생 시 문제가 발생할 수 있음     |
| **대안 4**: 데이터베이스 튜닝(쿼리 최적화)  | - 쿼리 성능 향상 가능 <br> - 인덱스 없이 성능을 개선 가능                                   | - DB 튜닝이 어려운 경우 성능 향상이 미미할 수 있음 <br> - 단순 쿼리의 경우 불필요                                 |

### 📌 선택된 결정
####  대기열 서비스 개선
- **인덱스를 추가하여 성능을 향상**: 가장 간단하고 빠르게 성능 개선이 가능하며, 단기적인 성능 향상에 효과적.
  - 추가적인 복잡한 시스템 변경 없이 성능 개선 가능.

####  콘서트 서비스 개선
- **쿼리 최적화 및 join 방식 개선**: Concert - Seat 사이에 concert_Seat 중간 테이블 구성 및 ConcertSeat 조회 시 좌석까지 fetch join으로 불러옴.
  - Seat 테이블에 concert_id 컬럼 제거 -> Concert_Seat에 의존함으로 관계의 명확한 분리 및 확장성 확보 (concert : seat = 1 : N).
  - 향후 ConcertSeat에 대한 메타데이터 추가 시 유연하게 확장 가능(구역, 등급 등등).
- **Seat 테이블 정규화**
  - Seat 테이블에서 concert_id 제거함으로써, 좌석 자체는 concertSeat에 종속됨.
  - 즉, 좌석은 공연이 아니라 "공연에 할당된 좌석 묶음" 단위로 관리됨 -> 재사용성 증가.
- 관계 해석 직관적
  - ConcertSeat는 말 그대로 '공연별 좌석 정보'를 의미하므로 도메인 모델로서 더 이해하기 쉽고 직관적인 해석 가능.

---

## ️📝 4. Consequences
###  📌 Benefits
- 조회 성능이 크게 개선되어, 대규모 이벤트 및 잦은 호출에 애플리케이션 성능 증가 기대.
- 관계 분리의 명확성 확보
  - 명확한 책임 분리로 인한 설계의 유연성과 명확성 향상.
- 확장성 증가
  - 향후 ConsertSeat에 구역, 등급, 가격대별 좌석 구성 등 메타데이터 추가 기대 가능.
  - 콘서트마다 다른 좌석 구성 표현 가능 -> 도메인 요구사항 변화에 유연 대응.

### 📌 Risks
- 인덱스 추가로 인해 디스크 공간을 추가로 차지할 수 있음.
- 초기에 Seat 테이블에서 바로 concert_id를 참조하던 구조를 변경해야 하므로, 데이터 이전 작업 필요.
- concert_id 제거 전에 데이터 정합성 검증 필수.

### 📌 후속 작업
- 인덱스가 제대로 작동하는지 확인하고 성능을 지속적으로 모니터링.
- 기존 Seat 테이블에서 concert_id 제거 및 레거시 리팩토링.